<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WELLCOOK</title>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <link rel="icon" type="image/svg+xml" href="./icon.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    borderRadius: {
                        '4xl': '2rem',
                        '5xl': '3rem',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Comfortaa:wght@300;700&family=Fredoka:wght@400;600;700&family=Gravitas+One&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Fredoka', sans-serif;
            background: radial-gradient(circle at top, #0f172a 0%, #020617 100%);
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            overscroll-behavior-y: contain;
        }

        .logo-font {
            font-family: 'Comfortaa', cursive;
        }

        .gourmet-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .active-tab {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white !important;
            box-shadow: 0 10px 20px -5px rgba(249, 115, 22, 0.4);
            transform: scale(1.02);
        }

        @keyframes success-pulse {
            0%, 100% { transform: scale(1); border-color: rgba(249, 115, 22, 0.2); }
            50% { transform: scale(1.02); border-color: #f97316; background: rgba(249, 115, 22, 0.1); }
        }
        .alarm-active {
            animation: success-pulse 0.8s infinite ease-in-out;
            border-width: 3px;
        }

        .big-time-bg {
            font-family: 'Gravitas One', serif;
            line-height: 0.7;
            pointer-events: none;
            color: #f97316; 
            font-size: 210px; 
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: -8px;
            opacity: 1 !important;
            padding-top: 16px; 
        }

        .highlight-label {
            position: relative;
            z-index: 10;
            display: inline-block;
            padding: 6px 16px;
            color: #000;
            font-family: 'Abril Fatface', serif;
        }

        .highlight-label::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(254, 252, 232, 0.8); 
            z-index: -1;
            transform: rotate(-2deg) skewX(-3deg);
            border-radius: 4px 25px 8px 30px / 10px 4px 15px 5px;
            box-shadow: 3px 3px 0px rgba(0,0,0,0.15);
            filter: url(#rough-edge);
        }

        .logo-card {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            border-radius: 0 0 3rem 3rem;
            box-shadow: 0 15px 40px -10px rgba(234, 88, 12, 0.5);
        }

        .tab-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .ai-loading {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .ad-container {
            background: rgba(15, 23, 42, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            min-height: 60px;
        }
        
        .ad-placeholder {
            font-size: 10px;
            color: rgba(255,255,255,0.2);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
    </style>
</head>
<body class="text-gray-100 min-h-screen pb-32">

    <svg style="position: absolute; width: 0; height: 0;">
        <filter id="rough-edge">
            <feTurbulence type="fractalNoise" baseFrequency="0.05" numOctaves="3" result="noise" />
            <feDisplacementMap in="SourceGraphic" in2="noise" scale="3" />
        </filter>
    </svg>

    <header class="top-0 z-50">
        <div class="logo-card mx-auto max-w-md p-8 sm:p-10 text-center border-x border-b border-white/10">
            <div class="logo-font text-5xl sm:text-6xl tracking-tighter w-full flex justify-center items-center">
                <span class="font-bold text-white">WELL</span><span class="font-light text-orange-100">COOK</span>
            </div>
            <p class="text-xs sm:text-sm text-white/90 uppercase tracking-[0.25em] font-bold mt-4 leading-relaxed">
                La cuisson parfaite,<br>à chaque fois
            </p>
        </div>
    </header>

    <main class="max-w-md mx-auto p-6 space-y-8">
        <div id="ai-chef-section" class="hidden">
            <div class="gourmet-card rounded-3xl p-5 border-orange-500/30 bg-orange-950/20">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-orange-400 font-bold text-sm uppercase tracking-widest">Le Chef IA ✨</span>
                    <button onclick="hideAiPanel()" class="text-gray-500 hover:text-white text-xl">&times;</button>
                </div>
                <div id="ai-response-content" class="text-sm text-gray-200 leading-relaxed italic"></div>
            </div>
        </div>

        <div id="timers-container" class="space-y-6"></div>

        <div id="ai-suggestion-btn" class="hidden">
            <button onclick="askAiForRecipe()" class="w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-600 rounded-2xl font-bold shadow-lg transform active:scale-95 transition-all text-sm uppercase tracking-widest">
                Chef IA : Que cuisiner avec ça ? ✨
            </button>
        </div>

        <div class="relative group">
            <input 
                type="text" 
                id="search-input" 
                placeholder="Qu'est-ce qu'on cuit ?" 
                oninput="handleSearch(this.value)"
                class="w-full bg-slate-900/80 border-2 border-slate-800 rounded-3xl py-5 px-8 text-lg text-gray-100 placeholder-gray-500 focus:outline-none focus:border-orange-500 transition-all shadow-inner"
            >
        </div>

        <div id="tabs-container" class="grid grid-cols-4 gap-2 bg-slate-900/40 p-1.5 rounded-3xl border border-white/5">
            <button onclick="switchCategory('eggs')" id="tab-eggs" class="tab-btn active-tab py-4 rounded-2xl transition-all">
                <span class="text-xs font-bold uppercase tracking-wider">Œufs</span>
            </button>
            <button onclick="switchCategory('potato')" id="tab-potato" class="tab-btn text-gray-400 py-4 rounded-2xl transition-all">
                <span class="text-xs font-bold uppercase tracking-wider">Patates</span>
            </button>
            <button onclick="switchCategory('pasta')" id="tab-pasta" class="tab-btn text-gray-400 py-4 rounded-2xl transition-all">
                <span class="text-xs font-bold uppercase tracking-wider">Pâtes</span>
            </button>
            <button onclick="switchCategory('grains')" id="tab-grains" class="tab-btn text-gray-400 py-4 rounded-2xl transition-all">
                <span class="text-xs font-bold uppercase tracking-wider">Céréales</span>
            </button>
        </div>

        <div id="options-grid" class="grid grid-cols-2 gap-5"></div>
    </main>

    <div class="fixed bottom-0 left-0 right-0 ad-container p-2 z-40 flex flex-col items-center">
        <div id="ad-slot" class="max-w-md w-full flex items-center justify-center overflow-hidden">
            <div class="ad-placeholder absolute inset-0 flex items-center justify-center pointer-events-none">Espace Publicitaire</div>
        </div>
    </div>

    <div id="ai-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-6 bg-black/80 backdrop-blur-sm hidden">
        <div class="gourmet-card w-full max-w-sm rounded-5xl p-8 border-orange-500/50">
            <h2 id="modal-title" class="text-2xl font-bold mb-4 text-orange-400 uppercase tracking-tighter">Astuce Chef ✨</h2>
            <div id="modal-body" class="text-gray-200 text-sm leading-relaxed mb-6">Chargement...</div>
            <button onclick="closeModal()" class="w-full py-4 bg-orange-600 rounded-2xl font-bold uppercase text-xs tracking-widest">Fermer</button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gradient-to-r from-orange-600 to-red-600 text-white px-10 py-5 rounded-full shadow-2xl opacity-0 pointer-events-none transition-all duration-300 z-50 font-bold text-lg text-center">
        À table ! C'est prêt !
    </div>

    <script>
        const apiKey = "AIzaSyDQnT4P51WkNMTXG6w-Fl9Nc4ruJOzrisw"; 

        const presets = {
            eggs: [
                { id: 'egg-coque', name: 'Œuf à la coque', time: 180 },
                { id: 'egg-mollet', name: 'Œuf mollet', time: 360 },
                { id: 'egg-poche', name: 'Œuf poché', time: 180 },
                { id: 'egg-dur', name: 'Œuf dur', time: 540 }
            ],
            potato: [
                { id: 'pot-water', name: "Patate à l'eau", time: 1200 },
                { id: 'pot-steam', name: "Patate vapeur", time: 1500 },
                { id: 'pot-oven', name: "Patate au four", time: 2700 },
                { id: 'pot-airfryer', name: "Air Fryer", time: 1080 }
            ],
            pasta: [
                { id: 'pasta-gnocchi', name: 'Gnocchi', time: 180 },
                { id: 'pasta-frais', name: 'Pâtes fraîches', time: 180 },
                { id: 'pasta-coquillettes', name: 'Coquillettes', time: 420 },
                { id: 'pasta-torsades', name: 'Torsades', time: 480 },
                { id: 'pasta-macaroni', name: 'Macaroni', time: 480 },
                { id: 'pasta-spaghetti', name: 'Spaghetti', time: 540 },
                { id: 'pasta-linguine', name: 'Linguine', time: 540 },
                { id: 'pasta-farfalle', name: 'Farfalle', time: 600 },
                { id: 'pasta-trofie', name: 'Trofie', time: 600 },
                { id: 'pasta-pipe', name: 'Pipe', time: 600 },
                { id: 'pasta-fusilli', name: 'Fusilli', time: 660 },
                { id: 'pasta-penne', name: 'Penne', time: 660 },
                { id: 'pasta-orecchiette', name: 'Orecchiette', time: 660 },
                { id: 'pasta-conchiglie', name: 'Conchiglie', time: 720 }
            ],
            grains: [
                { id: 'semolina-fine', name: 'Semoule fine', time: 180 },
                { id: 'semolina-normal', name: 'Semoule', time: 300 },
                { id: 'lentils-coral', name: 'Lentilles corail', time: 600 },
                { id: 'wheat-ebly', name: 'Blé', time: 600 },
                { id: 'bulgur', name: 'Boulgour', time: 600 },
                { id: 'rice-thai', name: 'Riz Thaï', time: 660 },
                { id: 'rice-basmati', name: 'Riz Basmati', time: 720 },
                { id: 'rice-round', name: 'Riz rond', time: 900 },
                { id: 'quinoa', name: 'Quinoa', time: 900 },
                { id: 'lentils', name: 'Lentilles', time: 1500 },
                { id: 'rice-black', name: 'Riz noir', time: 2100 }
            ]
        };

        let activeTimers = [];
        let audioCtx = null;
        let alarmInterval = null;
        let currentCategory = 'eggs';

        async function callGemini(prompt, systemPrompt) {
            if (!apiKey) return "API Key manquante";
            if (!navigator.onLine) return "Pas de connexion internet";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Erreur IA";
            } catch (e) { return "Erreur de connexion"; }
        }

        async function getAiTips(foodName) {
            const modal = document.getElementById('ai-modal');
            const modalBody = document.getElementById('modal-body');
            const modalTitle = document.getElementById('modal-title');
            modalTitle.innerText = `${foodName} ✨`;
            modalBody.innerHTML = `<div class="ai-loading">Le Chef prépare ses secrets...</div>`;
            modal.classList.remove('hidden');
            const response = await callGemini(`Conseils de pro pour : ${foodName}`, "Tu es un chef étoilé. Donne 3 astuces ultra-concises (max 20 mots total). Assaisonnement ou secret de cuisson.");
            modalBody.innerHTML = response.replace(/\n/g, '<br>');
        }

        async function askAiForRecipe() {
            const aiSection = document.getElementById('ai-chef-section');
            const aiContent = document.getElementById('ai-response-content');
            aiSection.classList.remove('hidden');
            aiContent.innerHTML = `<span class="ai-loading">Le Chef consulte son livre de recettes...</span>`;
            const ingredients = activeTimers.map(t => t.label).join(', ');
            const response = await callGemini(`Je cuis : ${ingredients}. Que faire avec ?`, "Suggère un plat simple. 1 phrase max.");
            aiContent.innerText = response;
        }

        function hideAiPanel() { document.getElementById('ai-chef-section').classList.add('hidden'); }
        function closeModal() { document.getElementById('ai-modal').classList.add('hidden'); }

        function initAudio() { 
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
            }
        }

        function playAlarmSound() {
            initAudio();
            if (navigator.vibrate) navigator.vibrate([300, 100, 300, 100, 500]);
            const gainNode = audioCtx.createGain();
            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.8);
            const osc = audioCtx.createOscillator();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, audioCtx.currentTime); 
            osc.connect(gainNode); gainNode.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.8);
        }

        function createTimer(seconds, label) {
            // FIX: Enregistrer le timestamp de fin pour la persistance
            const endTime = Date.now() + (seconds * 1000);
            activeTimers.push({ 
                id: Date.now(), 
                label, 
                totalTime: seconds, 
                endTime: endTime, // Heure réelle de fin
                timeLeft: seconds,
                notified: false 
            });
            updateAiButtonVisibility();
            renderTimers();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateAiButtonVisibility() {
            const btn = document.getElementById('ai-suggestion-btn');
            if (activeTimers.length > 0) btn.classList.remove('hidden');
            else { btn.classList.add('hidden'); hideAiPanel(); }
        }

        function removeTimer(id) {
            activeTimers = activeTimers.filter(t => t.id !== id);
            updateAiButtonVisibility();
            checkAlarms();
            renderTimers();
        }

        function checkAlarms() {
            const hasFinished = activeTimers.some(t => t.timeLeft <= 0);
            if (hasFinished && !alarmInterval) {
                alarmInterval = setInterval(playAlarmSound, 1200);
            } else if (!hasFinished && alarmInterval) {
                clearInterval(alarmInterval);
                alarmInterval = null;
            }
        }

        function renderTimers() {
            const container = document.getElementById('timers-container');
            if (!container) return;
            container.innerHTML = '';
            [...activeTimers].sort((a, b) => a.timeLeft - b.timeLeft).forEach(timer => {
                const mins = Math.floor(Math.max(0, timer.timeLeft) / 60);
                const secs = Math.max(0, timer.timeLeft) % 60;
                const progress = (Math.max(0, timer.timeLeft) / timer.totalTime) * 100;
                const isFinished = timer.timeLeft <= 0;
                const card = document.createElement('div');
                card.className = `gourmet-card rounded-5xl p-6 flex flex-col gap-4 ${isFinished ? 'alarm-active' : ''}`;
                card.innerHTML = `
                    <div class="flex justify-between items-center px-2">
                        <div>
                            <div class="flex items-center gap-2">
                                <h3 class="font-bold text-lg uppercase tracking-wide">${timer.label}</h3>
                                <button onclick="getAiTips('${timer.label}')" class="text-[10px] bg-white/10 px-2 py-1 rounded-full hover:bg-orange-500/30 transition-colors">ASTUCE ✨</button>
                            </div>
                            <p class="text-[10px] ${isFinished ? 'text-orange-400 font-bold' : 'text-gray-400'}">
                                ${isFinished ? 'C\'EST PRÊT !' : 'CUISSON EN COURS...'}
                            </p>
                        </div>
                        <div class="text-3xl font-bold font-mono">${mins}:${secs.toString().padStart(2, '0')}</div>
                    </div>
                    <div class="w-full bg-black/30 h-3 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-orange-400 to-orange-600 transition-all duration-100" style="width: ${progress}%"></div>
                    </div>
                    <button onclick="removeTimer(${timer.id})" class="w-full py-4 bg-white/5 rounded-2xl font-bold uppercase text-[10px] tracking-widest">
                        ${isFinished ? 'Fermer l\'alerte' : 'Arrêter'}
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function handleSearch(query) {
            const grid = document.getElementById('options-grid');
            const tabs = document.getElementById('tabs-container');
            if (!query.trim()) { tabs.classList.remove('hidden'); switchCategory(currentCategory); return; }
            tabs.classList.add('hidden');
            grid.innerHTML = '';
            Object.values(presets).flat()
                .filter(i => i.name.toLowerCase().includes(query.toLowerCase()))
                .forEach(item => renderOption(item));
        }

        function switchCategory(cat) {
            currentCategory = cat;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.replace('active-tab', 'text-gray-400'));
            const target = document.getElementById(`tab-${cat}`);
            if (target) target.classList.add('active-tab');
            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            presets[cat].forEach(item => renderOption(item));
        }

        function renderOption(item) {
            const grid = document.getElementById('options-grid');
            const div = document.createElement('div');
            div.className = 'gourmet-card min-h-[140px] rounded-4xl flex items-center justify-center text-center cursor-pointer group relative overflow-hidden';
            div.onclick = () => { initAudio(); createTimer(item.time, item.name); };
            let rawValue = item.time < 60 ? item.time : Math.floor(item.time / 60);
            div.innerHTML = `
                <div class="big-time-bg absolute inset-0">${rawValue}</div>
                <div class="relative z-10 px-2"><h3 class="highlight-label">${item.name}</h3></div>
            `;
            grid.appendChild(div);
        }

        function showToast() {
            const toast = document.getElementById('toast');
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 4000);
        }

        // BOUCLE PRINCIPALE : Utilisation de l'horloge système pour la persistance
        function updateAll() {
            const now = Date.now();
            let changed = false;

            activeTimers.forEach(timer => {
                // Calculer le temps restant réel par rapport au futur
                const diffMs = timer.endTime - now;
                const newTimeLeft = Math.ceil(diffMs / 1000);

                if (newTimeLeft !== timer.timeLeft) {
                    timer.timeLeft = newTimeLeft;
                    changed = true;
                    
                    // Notification au moment exact où ça tombe à zéro
                    if (timer.timeLeft <= 0 && !timer.notified) {
                        timer.notified = true;
                        showToast();
                        if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
                    }
                }
            });

            if (changed) {
                renderTimers();
                checkAlarms();
            }
            requestAnimationFrame(updateAll);
        }

        // Lancer la boucle
        requestAnimationFrame(updateAll);
        switchCategory('eggs');

        // Gérer le retour dans l'app pour forcer le rafraîchissement
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                renderTimers();
                checkAlarms();
            }
        });
    </script>
</body>
</html>
